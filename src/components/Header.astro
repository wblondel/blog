---
import { Icon } from "astro-icon/components";
import { getLangFromUrl, useTranslations } from "../i18n/utils";

interface Props {
  alternates?: { lang: string; href: string; isFallback?: boolean }[];
}

const { alternates } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const targetLang = lang === 'en' ? 'fr' : 'en';
const targetLabel = targetLang === 'en' ? 'EN' : 'FR';
const reverseLabel = targetLang === 'fr' ? 'Passer en Français' : 'Switch to English';

let targetRelativeHref = import.meta.env.BASE_URL;

// Safely strip BASE_URL to parse the relative path
let pathWithoutBase = Astro.url.pathname.startsWith(import.meta.env.BASE_URL)
    ? Astro.url.pathname.slice(import.meta.env.BASE_URL.length)
    : Astro.url.pathname.replace(/^\//, "");

// Strip the current language prefix if it exists
let pathWithoutLang = pathWithoutBase.replace(/^(en|fr)\//, "").replace(/^(en|fr)$/, "");
if (pathWithoutLang.startsWith('/')) {
    pathWithoutLang = pathWithoutLang.slice(1);
}

// Reconstruct the new localized path
targetRelativeHref = `${import.meta.env.BASE_URL}${targetLang}${pathWithoutLang ? '/' + pathWithoutLang : ''}`;

if (alternates) {
    const matchedAlt = alternates.find(a => a.lang === targetLang);
    if (matchedAlt) {
        try {
            const url = new URL(matchedAlt.href);
            targetRelativeHref = url.pathname;
        } catch {
            targetRelativeHref = matchedAlt.href;
        }
    }
}
---

<header
    id="site-header"
    class="sticky top-0 z-50 w-full py-4 bg-background backdrop-blur-sm transition-transform duration-300 translate-y-0 [&.is-hidden]:-translate-y-full"
>
    <a
        href="#main-content"
        class="sr-only focus:not-sr-only focus:absolute focus:left-4 focus:top-4 focus:z-50 focus:rounded-md focus:bg-background focus:px-4 focus:py-2 focus:text-sm focus:shadow"
        >Skip to main content</a
    >
    <div
        class="relative w-full mx-auto xl:max-w-[80rem] 2xl:max-w-[90rem] px-4 sm:px-12 md:px-18 lg:px-16 xl:px-10"
    >
        <div class="flex items-center justify-between gap-3 xl:hidden">
            <div class="flex items-center gap-3 min-w-0 flex-1">
                <a
                    href={`${import.meta.env.BASE_URL}${lang}`}
                    class="inline-flex items-center justify-center text-lg text-muted-foreground hover:text-foreground transition border rounded-md h-9 w-9 shrink-0 border-border hover:bg-muted"
                    ><Icon
                        name="fa6-solid:blog"
                        class="text-xl"
                        aria-hidden="true"
                    /><span class="sr-only">Blog</span>
                </a><a
                    title="William Blondel"
                    class="text-lg font-semibold text-foreground truncate min-w-0"
                    href={`${import.meta.env.BASE_URL}${lang}`}
                    >William Blondel</a
                >
            </div>
            <div class="flex items-center gap-2 shrink-0">
                <a
                    href={targetRelativeHref}
                    class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-bold transition-colors focus-visible:outline-hidden focus-visible:ring-1 focus-visible:ring-ring hover:bg-accent w-9 h-9 text-muted-foreground hover:text-foreground shadow-none"
                    title={reverseLabel}
                >
                    {targetLabel}
                </a>
                <button
                    class="gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-hidden focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:bg-accent py-2 h-9 w-9 px-0 flex items-center justify-center text-muted-foreground hover:text-foreground bg-transparent border-border shadow-none"
                    aria-label="Open search"
                    ><Icon
                        name="fa6-solid:magnifying-glass"
                        class="text-sm"
                        aria-hidden="true"
                    /><span class="sr-only">Open search</span>
                </button><button
                    class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-hidden focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:bg-accent w-9 px-3 h-9 text-muted-foreground hover:text-foreground shadow-none theme-toggle"
                    type="button"
                    aria-expanded="false"
                    ><Icon
                        name="fa6-solid:sun"
                        class="text-sm scale-100 rotate-0 transition-all dark:scale-0 dark:-rotate-90"
                        aria-hidden="true"
                    /><Icon
                        name="fa6-solid:moon"
                        class="absolute text-sm scale-0 rotate-90 transition-all dark:scale-100 dark:rotate-0"
                        aria-hidden="true"
                    /><span class="sr-only">Toggle theme</span>
                </button><button
                    id="mobile-menu-btn"
                    class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-hidden focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 border border-input bg-background hover:bg-accent hover:text-accent-foreground py-2 h-9 w-10 px-0 shadow-none"
                    type="button"
                    aria-haspopup="dialog"
                    aria-expanded="false"
                    ><Icon
                        name="fa6-solid:bars"
                        class=""
                        aria-hidden="true"
                    /><span class="sr-only">Open menu</span>
                </button>
            </div>
        </div>
        <div
            class="hidden xl:grid gap-4 items-center xl:grid-cols-[1fr_auto_1fr] xl:gap-6 max-w-full xl:mx-auto xl:max-w-[80rem] 2xl:max-w-[90rem]"
        >
            <div class="flex flex-wrap items-center w-full gap-3">
                <a
                    href={`${import.meta.env.BASE_URL}${lang}`}
                    class="inline-flex items-center justify-center text-lg text-muted-foreground hover:text-foreground transition border rounded-md h-9 w-9 border-border hover:bg-muted"
                    ><Icon
                        name="fa6-solid:blog"
                        class="text-xl"
                        aria-hidden="true"
                    /><span class="sr-only">Blog</span>
                </a><span class="h-6 border-l border-border"></span>
                <p
                    class="text-base font-semibold text-center sm:text-xl text-foreground max-w-[400px] truncate"
                >
                    <a
                        title="William Blondel"
                        href={`${import.meta.env.BASE_URL}${lang}`}
                        >William Blondel</a
                    >
                </p>
            </div>
            <nav
                aria-label="Main navigation"
                class="flex justify-center w-full"
            >
                <nav
                    aria-label="Main"
                    data-orientation="horizontal"
                    dir="ltr"
                    class="group/navigation-menu relative flex flex-1 items-center max-w-max justify-center"
                >
                    <div style="position:relative">
                        <ul
                            data-orientation="horizontal"
                            class="group flex flex-1 list-none items-center flex-nowrap justify-center gap-1 text-sm text-muted-foreground"
                            dir="ltr"
                        >
                            <li class="relative">
                                <a
                                    class="data-[active=true]:focus:bg-accent data-[active=true]:hover:bg-accent data-[active=true]:bg-accent/50 data-[active=true]:text-accent-foreground focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground flex-col p-2 outline-none focus-visible:outline-1 [&_svg:not([class*='size-'])]:size-4 inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-hidden focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2"
                                    href={`${
                                        import.meta.env.BASE_URL
                                    }${lang}/series/${t("nav.slug.offensive-ai")}`}
                                    >{t("nav.series.offensive-ai")}</a
                                >
                            </li>
                            <li class="relative">
                                <a
                                    class="data-[active=true]:focus:bg-accent data-[active=true]:hover:bg-accent data-[active=true]:bg-accent/50 data-[active=true]:text-accent-foreground focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground flex-col p-2 outline-none focus-visible:outline-1 [&_svg:not([class*='size-'])]:size-4 inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-hidden focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2"
                                    href={`${
                                        import.meta.env.BASE_URL
                                    }${lang}/series/${t("nav.slug.ai-defense")}`}
                                    >{t("nav.series.ai-defense")}</a
                                >
                            </li>
                            <li class="relative">
                                <a
                                    class="data-[active=true]:focus:bg-accent data-[active=true]:hover:bg-accent data-[active=true]:bg-accent/50 data-[active=true]:text-accent-foreground focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground flex-col p-2 outline-none focus-visible:outline-1 [&_svg:not([class*='size-'])]:size-4 inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-hidden focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2"
                                    href={`${
                                        import.meta.env.BASE_URL
                                    }${lang}/series/${t("nav.slug.secure-coding")}`}
                                    >{t("nav.series.secure-coding")}</a
                                >
                            </li>

                            <li class="relative group/more">
                                <button
                                    id="radix-_R_6ekiltlb_"
                                    data-state="closed"
                                    aria-expanded="false"
                                    class="group w-max focus:bg-accent focus:text-accent-foreground group-hover/more:bg-accent group-hover/more:text-accent-foreground outline-none focus-visible:outline-1 group inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-hidden focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:bg-accent py-2 h-9 px-3 text-muted-foreground hover:text-foreground bg-transparent shadow-none"
                                    type="button"
                                    aria-haspopup="menu"
                                    >{t("nav.more")}<!-- -->
                                    <span
                                        class="ml-1 flex items-center justify-center"
                                        ><Icon
                                            name="fa6-solid:angle-down"
                                            class="fa-jelly size-3 leading-none transition duration-300 group-hover/more:rotate-180"
                                            aria-hidden="true"
                                        />
                                    </span>
                                </button>
                                <div class="absolute -right-4 top-full pt-2 hidden min-w-[200px] flex-col group-hover/more:flex z-50">
                                    <div class="rounded-md border border-border bg-popover p-1 text-popover-foreground shadow-md">
                                        <a
                                            href={`${
                                                import.meta.env.BASE_URL
                                            }${lang}/series/${t("nav.slug.ai-governance")}`}
                                            class="relative flex cursor-pointer select-none items-center rounded-sm px-3 py-2 text-sm font-medium outline-none transition-colors hover:bg-accent hover:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50"
                                        >
                                            {t("nav.series.ai-governance")}
                                        </a>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>
            </nav>
            <div
                class="flex flex-wrap items-center justify-end gap-3 text-muted-foreground"
            >
                <button
                    class="gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-hidden focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:bg-accent py-2 h-9 w-9 px-0 flex items-center justify-center text-muted-foreground hover:text-foreground bg-transparent border-border shadow-none"
                    aria-label="Open search"
                    ><Icon
                        name="fa6-solid:magnifying-glass"
                        class="text-sm"
                        aria-hidden="true"
                    /><span class="sr-only">Open search</span>
                </button>
                <div class="flex items-center gap-3">
                    <a
                        href={targetRelativeHref}
                        class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-bold transition-colors focus-visible:outline-hidden focus-visible:ring-1 focus-visible:ring-ring hover:bg-accent w-9 h-9 text-muted-foreground hover:text-foreground shadow-none"
                        title={reverseLabel}
                    >
                        {targetLabel}
                    </a>
                    <button
                        class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-hidden focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 hover:bg-accent w-9 px-3 h-9 text-muted-foreground hover:text-foreground shadow-none theme-toggle"
                        type="button"
                        aria-expanded="false"
                        ><Icon
                            name="fa6-solid:sun"
                            class="text-sm scale-100 rotate-0 transition-all dark:scale-0 dark:-rotate-90"
                            aria-hidden="true"
                        /><Icon
                            name="fa6-solid:moon"
                            class="absolute text-sm scale-0 rotate-90 transition-all dark:scale-100 dark:rotate-0"
                            aria-hidden="true"
                        /><span class="sr-only">Toggle theme</span>
                    </button><button
                        class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-hidden focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 bg-primary text-primary-foreground hover:bg-primary/90 py-2 gap-2 px-3 h-9 shadow-none"
                        type="button"
                        aria-haspopup="dialog"
                        aria-expanded="false"
                        data-state="closed"
                        ><Icon
                            name="fa6-solid:envelope"
                            class="text-sm"
                            aria-hidden="true"
                        /><span class="flex items-center gap-1"
                            >{t("nav.subscribe")}</span
                        >
                    </button>
                </div>
            </div>
        </div>
    </div>
</header>

<div id="mobile-menu" data-state="closed" class="fixed inset-0 z-50 transition-all duration-300 data-[state=closed]:opacity-0 data-[state=closed]:pointer-events-none data-[state=open]:opacity-100">
    <div id="mobile-menu-backdrop" class="absolute inset-0 bg-background/80 backdrop-blur-sm"></div>
    <div class="absolute inset-y-0 right-0 z-50 h-full w-full sm:w-3/4 max-w-sm border-l border-border bg-background p-6 shadow-lg transition-transform duration-300 ease-in-out data-[state=closed]:translate-x-full data-[state=open]:translate-x-0 flex flex-col">
        <div class="flex items-center justify-end mb-8">
            <button id="mobile-menu-close" class="inline-flex items-center justify-center rounded-md border border-border text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background hover:bg-accent hover:text-accent-foreground h-8 w-8">
                <Icon name="fa6-solid:xmark" class="h-4 w-4" aria-hidden="true" />
                <span class="sr-only">Close</span>
            </button>
        </div>
        
        <nav class="flex flex-col gap-3 flex-1 overflow-y-auto">
            <a class="flex items-center justify-between rounded-md px-4 py-3 text-sm font-medium border border-border bg-background hover:bg-accent hover:text-accent-foreground transition-colors" href={`${import.meta.env.BASE_URL}${lang}/series/${t("nav.slug.offensive-ai")}`}>
                {t("nav.series.offensive-ai")}
                <Icon name="fa6-solid:angle-right" class="h-3 w-3 text-muted-foreground" aria-hidden="true" />
            </a>
            <a class="flex items-center justify-between rounded-md px-4 py-3 text-sm font-medium border border-border bg-background hover:bg-accent hover:text-accent-foreground transition-colors" href={`${import.meta.env.BASE_URL}${lang}/series/${t("nav.slug.ai-defense")}`}>
                {t("nav.series.ai-defense")}
                <Icon name="fa6-solid:angle-right" class="h-3 w-3 text-muted-foreground" aria-hidden="true" />
            </a>
            <a class="flex items-center justify-between rounded-md px-4 py-3 text-sm font-medium border border-border bg-background hover:bg-accent hover:text-accent-foreground transition-colors" href={`${import.meta.env.BASE_URL}${lang}/series/${t("nav.slug.secure-coding")}`}>
                {t("nav.series.secure-coding")}
                <Icon name="fa6-solid:angle-right" class="h-3 w-3 text-muted-foreground" aria-hidden="true" />
            </a>
            <a class="flex items-center justify-between rounded-md px-4 py-3 text-sm font-medium border border-border bg-background hover:bg-accent hover:text-accent-foreground transition-colors" href={`${import.meta.env.BASE_URL}${lang}/series/${t("nav.slug.ai-governance")}`}>
                {t("nav.series.ai-governance")}
                <Icon name="fa6-solid:angle-right" class="h-3 w-3 text-muted-foreground" aria-hidden="true" />
            </a>
        </nav>
    </div>
</div>

<script>
    const themeButtons = document.querySelectorAll(".theme-toggle");
    themeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
            const isDark = document.documentElement.classList.contains("dark");
            if (isDark) {
                document.documentElement.classList.remove("dark");
                localStorage.setItem("theme", "light");
            } else {
                document.documentElement.classList.add("dark");
                localStorage.setItem("theme", "dark");
            }
        });
    });

    const mobileMenuBtn = document.getElementById("mobile-menu-btn");
    const mobileMenuCloseBtn = document.getElementById("mobile-menu-close");
    const mobileMenuDialog = document.getElementById("mobile-menu");
    const mobileMenuBackdrop = document.getElementById("mobile-menu-backdrop");

    if (mobileMenuBtn && mobileMenuCloseBtn && mobileMenuDialog && mobileMenuBackdrop) {
        const openMenu = () => {
            mobileMenuDialog.setAttribute("data-state", "open");
            document.body.style.overflow = "hidden"; // Prevent background scrolling
            
            // Focus the close button for accessibility, matching Hashnode's behavior
            setTimeout(() => {
                mobileMenuCloseBtn.focus();
            }, 100);
        };

        const closeMenu = () => {
            mobileMenuDialog.setAttribute("data-state", "closed");
            document.body.style.overflow = ""; // Restore background scrolling
        };

        mobileMenuBtn.addEventListener("click", openMenu);
        mobileMenuCloseBtn.addEventListener("click", closeMenu);
        mobileMenuBackdrop.addEventListener("click", closeMenu);
    }

    // ── Scroll-hide / show header ─────────────────────────────────────────────
    const header = document.getElementById("site-header");
    if (header) {
        let lastScrollY = window.scrollY;
        const THRESHOLD = 10; // px — ignore tiny micro-scrolls

        // Track programmatic scrolls (e.g. TOC / anchor clicks)
        // so we don't re-show the header when they scroll upward
        let isProgrammaticScroll = false;
        document.addEventListener("click", (e) => {
            const anchor = (e.target as Element)?.closest('a[href^="#"]');
            if (!anchor) return;
            isProgrammaticScroll = true;
            // Reset when scroll settles (scrollend) or after 1s fallback
            const reset = () => { isProgrammaticScroll = false; };
            window.addEventListener("scrollend", reset, { once: true });
            setTimeout(reset, 1000);
        });

        window.addEventListener("scroll", () => {
            const currentScrollY = window.scrollY;
            const delta = currentScrollY - lastScrollY;

            if (currentScrollY <= 0) {
                // Always show at the very top
                header.classList.remove("is-hidden");
            } else if (delta > THRESHOLD) {
                // Scrolling DOWN — hide
                header.classList.add("is-hidden");
                // Also close the mobile menu if it was open
                mobileMenuDialog?.setAttribute("data-state", "closed");
                document.body.style.overflow = "";
            } else if (delta < -THRESHOLD && !isProgrammaticScroll) {
                // Scrolling UP manually — show (not triggered by anchor clicks)
                header.classList.remove("is-hidden");
            }

            lastScrollY = currentScrollY;
        }, { passive: true });
    }
</script>