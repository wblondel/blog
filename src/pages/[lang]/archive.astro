---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import PageHeader from "../../components/PageHeader.astro";
import { useTranslations, usePlural } from "../../i18n/utils";
import { languages } from "../../i18n/ui";

export function getStaticPaths() {
    return Object.keys(languages).map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params;
const t = useTranslations(lang as any);
const p = usePlural(lang as any);

const allPosts = await getCollection("blog", ({ slug }) =>
    slug.startsWith(`${lang}/`)
);
allPosts.sort(
    (a: CollectionEntry<"blog">, b: CollectionEntry<"blog">) =>
        b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Build hreflang alternates
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
const archiveAlternates = [
    { lang: 'en', href: new URL(`${base}/en/archive`, Astro.site).toString() },
    { lang: 'fr', href: new URL(`${base}/fr/archive`, Astro.site).toString() },
    { lang: 'x-default', href: new URL(`${base}/en/archive`, Astro.site).toString() },
];
---

<Layout
    title={`${t("archive.title")} - William Blondel`}
    description={t('archive.pageDescription' as any)}
    alternates={archiveAlternates}
    ogImage={`${import.meta.env.BASE_URL}og-default.png`}
>
    <div class="w-full mx-auto max-w-4xl px-4 py-16 sm:px-8 sm:py-24">
        <PageHeader title={t("archive.title")} subtitle={p(allPosts.length, "archive.subtitle")} />

        <div class="flex flex-col max-w-3xl mx-auto">
            {
                allPosts.map((post) => (
                    <article class="flex flex-col sm:flex-row gap-1 sm:gap-8 sm:items-baseline py-5 border-b border-border last:border-0 hover:bg-muted/50 transition-colors px-4 rounded-lg -mx-4">
                        <time
                            class="text-sm font-medium text-muted-foreground whitespace-nowrap sm:w-32 shrink-0"
                            datetime={post.data.pubDate.toISOString()}
                        >
                            {post.data.pubDate.toLocaleDateString(lang, {
                                year: "numeric",
                                month: "short",
                                day: "numeric",
                            })}
                        </time>
                        <a
                            href={`${import.meta.env.BASE_URL}${lang}/${post.slug.split("/").pop()}`}
                            class="text-lg font-medium text-foreground hover:text-primary transition-colors flex-1"
                        >
                            {post.data.title}
                        </a>
                    </article>
                ))
            }
        </div>
    </div>
</Layout>
