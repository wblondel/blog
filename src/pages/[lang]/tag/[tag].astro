---
import { getCollection, type CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import Layout from "../../../layouts/Layout.astro";
import { getLangFromUrl, useTranslations, usePlural } from "../../../i18n/utils";

export async function getStaticPaths() {
    const allPosts = await getCollection("blog");
    
    // Map tag data: lang -> Set<string> of tag IDs
    const tagsByLang: Record<string, Set<string>> = {
        en: new Set(),
        fr: new Set()
    };
    
    interface TagMap {
        [dateVal: number]: string[];
    }
    // pubDate.valueOf() -> tags array per post
    const postTagsByDate: Record<string, TagMap> = {
        en: {},
        fr: {}
    };

    allPosts.forEach((post: CollectionEntry<"blog">) => {
        const lang = post.slug.split('/')[0] as 'en' | 'fr';
        if (post.data.tags) {
            const rawTags = post.data.tags.map(t => t.toLowerCase().replace(/\s+/g, "-"));
            rawTags.forEach(tag => tagsByLang[lang].add(tag));
            postTagsByDate[lang][post.data.pubDate.valueOf()] = rawTags;
        }
    });

    const paths: any[] = [];
    
    // Generate paths strictly for existing tags per language
    Object.keys(tagsByLang).forEach((lang) => {
        tagsByLang[lang].forEach((tag) => {
            // Find which articles have this tag
            let relatedDates: number[] = [];
            for (const [dateVal, tgs] of Object.entries(postTagsByDate[lang])) {
                if (tgs.includes(tag)) relatedDates.push(Number(dateVal));
            }
            
            // Generate alternates by checking those exact same dates in other languages
            let alternates: { lang: string; href: string }[] = [];
            
            // Add self
            alternates.push({
                lang: lang,
                href: `${import.meta.env.BASE_URL.slice(1)}${lang}/tag/${tag}` // temporary relative path for template processing
            });

            // Find translation in other languages
            const otherLangs = ['en', 'fr'].filter(l => l !== lang);
            for (const otherLang of otherLangs) {
                // Find potential translated tags
                let possibleTags: Record<string, number> = {};
                for (const d of relatedDates) {
                    const transTags = postTagsByDate[otherLang]?.[d];
                    if (transTags) {
                        for (const t of transTags) {
                            possibleTags[t] = (possibleTags[t] || 0) + 1;
                        }
                    }
                }
                
                // If there's a highly correlated tag, link it!
                if (Object.keys(possibleTags).length > 0) {
                    // Get the tag that appeared in the most translated identical posts
                    const mostLikelyTag = Object.keys(possibleTags).reduce((a, b) => possibleTags[a] > possibleTags[b] ? a : b);
                    alternates.push({
                        lang: otherLang,
                        href: `${import.meta.env.BASE_URL.slice(1)}${otherLang}/tag/${mostLikelyTag}`
                    });
                }
            }

            paths.push({
                params: { lang, tag },
                props: { tagId: tag, rawAlternates: alternates },
            });
        });
    });

    return paths;
}

const { tagId, rawAlternates } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang as any);
const p = usePlural(lang as any);

// Resolve alternates correctly with Astro.site
const alternates = rawAlternates.map((alt: any) => ({
    lang: alt.lang,
    href: `${Astro.site}${alt.href}`
}));
const xDefault = alternates.find((a: any) => a.lang === 'en') || alternates[0];
if (xDefault) {
    alternates.push({ lang: 'x-default', href: xDefault.href });
}

const allPosts = await getCollection("blog", ({ slug }: { slug: string }) =>
    slug.startsWith(`${lang}/`)
);
const tagPosts = allPosts.filter(
    (post: CollectionEntry<"blog">) =>
        post.data.tags &&
        post.data.tags
            .map((tg: string) => tg.toLowerCase().replace(/\s+/g, "-"))
            .includes(tagId as string)
);

// We need the original tag name for display
const originalTag =
    tagPosts.length > 0
        ? tagPosts[0].data.tags?.find(
              (tg: string) => tg.toLowerCase().replace(/\s+/g, "-") === tagId
          )
        : tagId;
---

<Layout
    title={`#${originalTag}`}
    description={`Posts tagged with #${originalTag}`}
    alternates={alternates}
>
    <div class="px-4 sm:px-8">
        <div class="w-full xl:mx-auto xl:max-w-[80rem] 2xl:max-w-[90rem]">
            <div class="flex flex-col gap-8 pt-2 sm:pt-10">
                <section class="pb-16">
                    <div class="space-y-8 max-w-4xl w-full mx-auto">
                        <header class="mb-8 space-y-4 text-center">
                            <div class="flex flex-col items-center gap-3">
                                <h1
                                    class="text-3xl sm:text-4xl font-bold tracking-tight text-balance text-foreground"
                                >
                                    <span
                                        class="text-muted-foreground font-normal"
                                        >#</span
                                    >{originalTag}
                                </h1>
                                <span
                                    class="inline-flex items-center rounded-full border border-border px-3 py-1 text-sm font-semibold uppercase tracking-wide text-muted-foreground"
                                    aria-label={`${p(tagPosts.length, "generic.posts")} with this tag`}
                                    >{p(tagPosts.length, "generic.posts")}</span
                                >
                            </div>
                        </header>

                        {
                            tagPosts.length === 0 ? (
                                <div class="flex flex-col items-center justify-center rounded-2xl border border-dashed border-border p-12 text-center">
                                    <p class="text-lg font-semibold text-muted-foreground">
                                        {t('generic.noPosts')}
                                    </p>
                                </div>
                            ) : (
                                <div class="grid grid-cols-1 gap-6">
                                    {tagPosts.map(
                                        (post: CollectionEntry<"blog">) => (
                                            <article class="h-full">
                                                <a
                                                    class="block h-full"
                                                    href={`${
                                                        import.meta.env.BASE_URL
                                                    }${lang}/${post.slug
                                                        .split("/")
                                                        .pop()}`}
                                                >
                                                    <div class="rounded-xl border bg-card text-card-foreground transition hover:border-slate-400 dark:hover:border-slate-600 h-full">
                                                        <div class="grid h-full gap-4 p-4 items-stretch md:gap-6 md:p-6 md:grid-cols-[1.2fr_1fr]">
                                                            <div class="flex flex-col gap-4">
                                                                <header class="flex flex-col gap-3">
                                                                    <h3 class="text-foreground text-lg sm:text-xl font-semibold transition-colors line-clamp-3">
                                                                        {
                                                                            post
                                                                                .data
                                                                                .title
                                                                        }
                                                                    </h3>
                                                                    {post.data
                                                                        .description && (
                                                                        <p class="text-sm text-muted-foreground line-clamp-3">
                                                                            {
                                                                                post
                                                                                    .data
                                                                                    .description
                                                                            }
                                                                        </p>
                                                                    )}
                                                                </header>
                                                                <div class="flex flex-wrap items-center gap-3 text-sm text-muted-foreground">
                                                                    <span class="whitespace-nowrap">
                                                                        {post.data.pubDate.toLocaleDateString(
                                                                            lang,
                                                                            {
                                                                                year: "numeric",
                                                                                month: "short",
                                                                                day: "numeric",
                                                                            }
                                                                        )}
                                                                    </span>
                                                                    <span class="whitespace-nowrap">
                                                                        <span
                                                                            class="mr-3"
                                                                            aria-hidden="true"
                                                                        >
                                                                            Â·
                                                                        </span>
                                                                        {
                                                                            post
                                                                                .data
                                                                                .readTime
                                                                        }{" "}
                                                                        {t("article.readTime")}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                            {post.data.coverImage && (
                                                                <div class="flex items-center md:justify-end order-first md:order-last">
                                                                    {typeof post.data.coverImage === 'string' ? (
                                                                        <div class="relative overflow-hidden rounded-lg bg-muted aspect-[8/5] w-full md:max-w-[320px]">
                                                                            <Image inferSize={true} width={800} alt={post.data.title} loading="lazy" decoding="async" class="object-cover object-center w-full h-full absolute inset-0 text-transparent" src={post.data.coverImage} />
                                                                        </div>
                                                                    ) : (
                                                                        <div class="relative overflow-hidden rounded-lg bg-muted aspect-[8/5] w-full md:max-w-[320px]">
                                                                            <Image widths={[400, 800]} sizes="(max-width: 800px) 100vw, 800px" alt={post.data.title} loading="lazy" decoding="async" class="object-cover object-center w-full h-full absolute inset-0 text-transparent" src={post.data.coverImage} />
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </a>
                                            </article>
                                        )
                                    )}
                                </div>
                            )
                        }
                    </div>
                </section>
            </div>
        </div>
    </div>
</Layout>
