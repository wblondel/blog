---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import PostCard from "../../../components/PostCard.astro";
import EmptyState from "../../../components/EmptyState.astro";
import noPostsIllustration from "../../../assets/LrrwlBZC0.webp";
import { getLangFromUrl, useTranslations, usePlural } from "../../../i18n/utils";

export async function getStaticPaths() {
    const seriesEntries = await getCollection("series");
    
    // Group series dynamically by their frontmatter translationKey
    const seriesByTranslationKey: Record<string, {lang: string, slug: string}[]> = {};
    
    seriesEntries.forEach((entry: CollectionEntry<"series">) => {
        const [lang, ...slugParts] = entry.slug.split("/");
        const slug = slugParts.join("/");
        const tKey = entry.data.translationKey || slug; // Fallback to slug if no key exists
        
        if (!seriesByTranslationKey[tKey]) seriesByTranslationKey[tKey] = [];
        seriesByTranslationKey[tKey].push({ lang, slug });
    });

    return seriesEntries.map((entry: CollectionEntry<"series">) => {
        const [lang, ...slugParts] = entry.slug.split("/");
        const slug = slugParts.join("/");
        const tKey = entry.data.translationKey || slug;
        
        // Generate alternates mapping using the dynamically linked group
        const translations = seriesByTranslationKey[tKey] || [];
        const rawAlternates = translations.map(t => ({
            lang: t.lang,
            href: `${import.meta.env.BASE_URL.slice(1)}${t.lang}/series/${t.slug}/`
        }));

        return {
            params: { lang, slug },
            props: { entry, rawAlternates },
        };
    });
}

const { entry, rawAlternates } = Astro.props;
const { title, description } = entry.data;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang as any);
const p = usePlural(lang as any);

// Resolve alternate URLs
const alternates = rawAlternates?.map((alt: any) => ({
    lang: alt.lang,
    href: `${Astro.site}${alt.href}`
})) || [];

const xDefault = alternates.find((a: any) => a.lang === 'en') || alternates[0];
if (xDefault) {
    alternates.push({ lang: 'x-default', href: xDefault.href });
}

const allPosts = await getCollection("blog", ({ slug }: { slug: string }) =>
    slug.startsWith(`${lang}/`)
);
const seriesPosts = allPosts
    .filter(
        (post: CollectionEntry<"blog">) =>
            post.data.series === entry.slug.split("/").pop()
    )
    .sort((a, b) => (a.data.seriesOrder || 0) - (b.data.seriesOrder || 0));
---

<Layout
    title={title}
    description={description}
    alternates={alternates}
    ogImage={`${import.meta.env.BASE_URL}og-default.png`}
    ogImageAlt={title}
>
    <div class="px-4 sm:px-8">
        <div class="w-full xl:mx-auto xl:max-w-[80rem] 2xl:max-w-[90rem]">
            <div class="flex flex-col gap-8 pt-2 sm:pt-10">
                <section class="pb-16">
                    <div class="space-y-8 max-w-4xl w-full mx-auto">
                        <header class="mb-8 space-y-4 text-center">
                            <p
                                class="text-sm font-semibold uppercase tracking-wide text-muted-foreground"
                            >
                                {t("nav.series") || "Series"}
                            </p>
                            <div class="flex flex-col items-center gap-3">
                                <h1
                                    class="text-3xl sm:text-4xl font-bold tracking-tight text-balance text-foreground"
                                >
                                    {title}
                                </h1>
                                <span
                                    class="inline-flex items-center rounded-full border border-border px-3 py-1 text-sm font-semibold uppercase tracking-wide text-muted-foreground"
                                    aria-label={`${p(seriesPosts.length, "generic.posts")} in this series`}
                                    >{p(seriesPosts.length, "generic.posts")}</span
                                >
                            </div>
                            <div
                                class="prose prose-lg dark:prose-invert max-w-none text-muted-foreground"
                            >
                                <p>{description}</p>
                            </div>
                        </header>

                        {
                            seriesPosts.length === 0 ? (
                                <EmptyState message={t('generic.noPosts')} image={noPostsIllustration} imageAlt="No posts illustration" />
                            ) : (
                                <div class="grid grid-cols-1 gap-6">
                                    {seriesPosts.map((post: CollectionEntry<"blog">) => (
                                        <PostCard
                                            post={post}
                                            lang={lang}
                                            variant="horizontal"
                                            showSeriesOrder={true}
                                        />
                                    ))}
                                </div>
                            )
                        }
                    </div>
                </section>
            </div>
        </div>
    </div>
</Layout>
