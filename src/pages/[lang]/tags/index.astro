---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import PageHeader from "../../../components/PageHeader.astro";
import EmptyState from "../../../components/EmptyState.astro";
import { useTranslations, usePlural } from "../../../i18n/utils";
import { languages } from "../../../i18n/ui";

export function getStaticPaths() {
    return Object.keys(languages).map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params;
const t = useTranslations(lang as any);
const p = usePlural(lang as any);

const allPosts = await getCollection("blog", ({ slug }) =>
    slug.startsWith(`${lang}/`)
);

// Calculate tag frequencies and store original names
const tagsMap = new Map<string, { name: string; count: number }>();

allPosts.forEach((post) => {
    if (post.data.tags) {
        post.data.tags.forEach((tag: string) => {
            const id = tag.toLowerCase().replace(/\s+/g, "-");
            if (tagsMap.has(id)) {
                tagsMap.get(id)!.count++;
            } else {
                tagsMap.set(id, { name: tag, count: 1 });
            }
        });
    }
});

// Convert to array and sort by count descending, then alphabetically
const sortedTags = Array.from(tagsMap.entries())
    .map(([id, data]) => ({ id, name: data.name, count: data.count }))
    .sort((a, b) => {
        if (b.count !== a.count) return b.count - a.count;
        return a.name.localeCompare(b.name);
    });
// Sorted tag list computed above

// Build hreflang alternates (no hardcoded URLs)
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
const tagsAlternates = [
    { lang: 'en', href: new URL(`${base}/en/tags/`, Astro.site).toString() },
    { lang: 'fr', href: new URL(`${base}/fr/tags/`, Astro.site).toString() },
];
---

<Layout
    title={`${t("tags.title")} — William Blondel Blog`}
    description={t('tags.pageDescription' as any)}
    alternates={tagsAlternates}
    ogImage={`${import.meta.env.BASE_URL}og-default.png`}
>
    <div class="w-full mx-auto max-w-4xl px-4 py-16 sm:px-8 sm:py-24">
        <PageHeader title={t("tags.title")} subtitle={p(sortedTags.length, "tags.subtitle")} srOnlySuffix=" — William Blondel Blog" />

        {
            sortedTags.length === 0 ? (
                <EmptyState message={t("tags.noPosts")} />
            ) : (
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {sortedTags.map((tag) => (
                        <a
                            href={`${import.meta.env.BASE_URL}${lang}/tag/${tag.id}/`}
                            class="flex items-center justify-between p-4 rounded-xl border bg-card text-card-foreground transition hover:border-slate-400 dark:hover:border-slate-600 hover:shadow-sm"
                        >
                            <div class="flex items-center gap-2 min-w-0">
                                <span class="text-muted-foreground font-normal">
                                    #
                                </span>
                                <span class="font-medium text-foreground truncate">
                                    {tag.name}
                                </span>
                            </div>
                            <span
                                class="inline-flex items-center rounded-full bg-muted border border-border px-2.5 py-0.5 text-xs font-semibold text-muted-foreground shrink-0"
                                aria-label={`${tag.count} posts`}
                            >
                                {tag.count}
                            </span>
                        </a>
                    ))}
                </div>
            )
        }
    </div>
</Layout>
