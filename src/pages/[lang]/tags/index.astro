---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import { useTranslations } from "../../../i18n/utils";
import { languages } from "../../../i18n/ui";

export function getStaticPaths() {
    return Object.keys(languages).map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params;
const t = useTranslations(lang as any);

const allPosts = await getCollection("blog", ({ slug }) =>
    slug.startsWith(`${lang}/`)
);

// Calculate tag frequencies and store original names
const tagsMap = new Map<string, { name: string; count: number }>();

allPosts.forEach((post) => {
    if (post.data.tags) {
        post.data.tags.forEach((tag: string) => {
            const id = tag.toLowerCase().replace(/\s+/g, "-");
            if (tagsMap.has(id)) {
                tagsMap.get(id)!.count++;
            } else {
                tagsMap.set(id, { name: tag, count: 1 });
            }
        });
    }
});

// Convert to array and sort by count descending, then alphabetically
const sortedTags = Array.from(tagsMap.entries())
    .map(([id, data]) => ({ id, name: data.name, count: data.count }))
    .sort((a, b) => {
        if (b.count !== a.count) return b.count - a.count;
        return a.name.localeCompare(b.name);
    });
---

<Layout
    title={`${t("tags.title")} - William Blondel`}
    description="Browse all available tags for the blog"
>
    <div class="w-full mx-auto max-w-4xl px-4 py-16 sm:px-8 sm:py-24">
        <header class="mb-16 text-center">
            <h1
                class="text-4xl font-bold tracking-tight text-foreground sm:text-5xl"
            >
                {t("tags.title")}
            </h1>
            <p class="mt-4 text-lg text-muted-foreground">
                {sortedTags.length}
                {t("tags.subtitle")}
            </p>
        </header>

        {
            sortedTags.length === 0 ? (
                <div class="flex flex-col items-center justify-center rounded-2xl border border-dashed border-border p-12 text-center">
                    <p class="text-lg font-semibold text-muted-foreground">
                        No tags yet
                    </p>
                </div>
            ) : (
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {sortedTags.map((tag) => (
                        <a
                            href={`/${lang}/tag/${tag.id}`}
                            class="flex items-center justify-between p-4 rounded-xl border bg-card text-card-foreground transition hover:border-slate-400 dark:hover:border-slate-600 hover:shadow-sm"
                        >
                            <div class="flex items-center gap-2 min-w-0">
                                <span class="text-muted-foreground font-normal">
                                    #
                                </span>
                                <span class="font-medium text-foreground truncate">
                                    {tag.name}
                                </span>
                            </div>
                            <span
                                class="inline-flex items-center rounded-full bg-muted border border-border px-2.5 py-0.5 text-xs font-semibold text-muted-foreground shrink-0"
                                aria-label={`${tag.count} posts`}
                            >
                                {tag.count}
                            </span>
                        </a>
                    ))}
                </div>
            )
        }
    </div>
</Layout>
