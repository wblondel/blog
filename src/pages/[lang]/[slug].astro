---
import { Icon } from 'astro-icon/components';
import { getCollection, type CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';
import Layout from '../../layouts/Layout.astro';
import AuthorCard from '../../components/AuthorCard.astro';
import CoverImage from '../../components/CoverImage.astro';
import { getLangFromUrl, useTranslations } from '../../i18n/utils';

export async function getStaticPaths() {
  const blogs = await getCollection('blog');
  return blogs.map((entry: CollectionEntry<'blog'>) => {
    const [lang, ...slugParts] = entry.slug.split('/');
    const slug = slugParts.join('/');
    return {
      params: { lang, slug },
      props: { entry },
    };
  });
}

interface Props {
  entry: CollectionEntry<'blog'>;
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();
const { title, description, pubDate, coverImage, tags, series, readTime } = entry.data;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang as any);
const formattedDate = pubDate.toLocaleDateString(lang, { year: 'numeric', month: 'long', day: 'numeric' });

let seriesData = null;
if (series) {
    const seriesCollection = await getCollection('series');
    seriesData = seriesCollection.find((s: CollectionEntry<'series'>) => s.slug === `${lang}/${series}`);
}

const allBlogs = await getCollection('blog');
const translatedEntries = allBlogs.filter((b: CollectionEntry<'blog'>) => b.data.pubDate.valueOf() === pubDate.valueOf());

const alternates: { lang: string; href: string }[] = translatedEntries.map((b: CollectionEntry<'blog'>) => {
    const bLang = b.slug.split('/')[0];
    const bSlug = b.slug.split('/').slice(1).join('/');
    return {
        lang: bLang,
        href: `${Astro.site}${import.meta.env.BASE_URL.slice(1)}${bLang}/${bSlug}`
    };
});
const xDefault = alternates.find(a => a.lang === 'en') || alternates[0];
if (xDefault) {
    alternates.push({ lang: 'x-default', href: xDefault.href });
}

// Point to the dynamically-generated Satori OG image endpoint
const postSlug = entry.slug.split('/').slice(1).join('/');
const ogImageURL = new URL(`${import.meta.env.BASE_URL}${lang}/${postSlug}/og.png`, Astro.site).toString();

// Count total posts for this language (for the author card)
const postCount = allBlogs.filter((b: CollectionEntry<'blog'>) => b.slug.startsWith(`${lang}/`)).length;

const articleSchema = JSON.stringify({
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description,
  "image": ogImageURL ? [new URL(ogImageURL, Astro.site).toString()] : undefined,
  "datePublished": pubDate.toISOString(),
  "author": [{
      "@type": "Person",
      "name": "William Blondel",
      "url": new URL(`${import.meta.env.BASE_URL}${lang}`, Astro.site).toString()
  }]
});
---
<Layout title={title} description={description} alternates={alternates} ogImage={ogImageURL} ogType="article" articleSchema={articleSchema}>
    <section class="py-8">
        <div class="px-4 sm:px-8">
            <div class="w-full max-w-full xl:mx-auto xl:max-w-[80rem] 2xl:max-w-[90rem]">
                <div class="grid gap-5 max-w-full">
                    <article class="w-full max-w-full rounded-xl border bg-card text-card-foreground">
                        <div class="px-5 pt-12 pb-8 sm:px-8">
                            <header class="space-y-5">
                                <div class="space-y-3 text-center max-w-2xl mx-auto">
                                    <h1 class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl font-bold text-balance text-foreground transition-colors">{title}</h1>
                                    {description && <p class="text-base sm:text-lg font-normal text-muted-foreground text-balance">{description}</p>}
                                    <div class="flex flex-wrap items-center justify-center gap-3 text-sm text-muted-foreground">
                                        <div class="flex items-center gap-2"><Icon name="fa6-solid:calendar" class="h-4 w-4 text-muted-foreground" aria-hidden="true" /><span>{t("article.updatedOn")}</span><time datetime={pubDate.toISOString()}>{formattedDate}</time></div><span class="text-muted-foreground">â€¢</span><div class="flex items-center gap-2"><Icon name="fa6-solid:clock" class="h-4 w-4 text-muted-foreground" aria-hidden="true" /><span>{readTime} <!-- -->{t("article.readTime")}</span></div>
                                    </div>
                                </div>
                            </header>
                        </div>
        {coverImage && (
            <CoverImage
                src={coverImage}
                alt={title}
                loading="eager"
                fetchpriority="high"
                widths={[400, 800, 1200]}
                sizes="(max-width: 1200px) 100vw, 1200px"
                maxWidth={1200}
                wrapperClass="relative w-full overflow-hidden aspect-[8/5]"
                imgClass="w-full h-full object-cover"
            />
        )}
                        <div class="px-5 py-12 sm:px-8 space-y-8">
                            <div class="max-w-2xl mx-auto">
                                <div class="flex flex-col gap-5">
                                    <div class="flex gap-3 items-start"><a target="_blank" rel="noopener" href={`${import.meta.env.BASE_URL}${lang}`}><span class="relative flex shrink-0 overflow-hidden rounded-full h-10 w-10 border border-border transition-opacity hover:opacity-80"><span class="flex h-full w-full items-center justify-center rounded-full bg-muted text-muted-foreground font-semibold text-lg">W</span></span></a><div class="min-w-0"><a target="_blank" rel="noopener" class="hover:text-primary transition-colors" href={`${import.meta.env.BASE_URL}${lang}`}><p class="font-medium text-foreground">William Blondel</p></a><div class="text-sm text-muted-foreground line-clamp-2"><p>Hi there ðŸ‘‹! I'm a Senior Full Stack Web Developer. I dedicate my free time to uncovering family history through genealogy.</p></div></div></div>
                                </div>
                            </div>
                            
                            {seriesData && (
                            <div class="max-w-2xl mx-auto">
                                <a class="group flex items-center gap-3 rounded-lg border border-border px-3 py-2 transition hover:border-primary hover:bg-accent" href={`${import.meta.env.BASE_URL}${lang}/series/${series}`}>
                                    <Icon name="fa6-solid:layer-group" class="h-4 w-4 text-muted-foreground group-hover:text-primary transition-colors" aria-hidden="true" />
                                    <div class="flex flex-col"><span class="text-sm text-muted-foreground">{entry.data.seriesOrder ? `${t('article.part') || 'Part'} ${entry.data.seriesOrder} of series` : 'Part of series'}</span><span class="text-sm font-medium text-foreground group-hover:text-primary transition-colors">{seriesData.data.title}</span></div>
                                </a>
                            </div>
                            )}

                            <div class="relative">
                                <aside class="hidden xl:block absolute top-0 left-0 h-full">
                                    <nav class="sticky top-8 w-44">
                                        <div class="hidden xl:block max-h-[calc(100vh-3rem)] overflow-y-auto">
                                            <p class="text-sm font-semibold uppercase tracking-wide text-muted-foreground mb-3">{t("article.onThisPage")}</p>
                                            <nav aria-label="On this page">
                                                {headings.map((heading) => (
                                                    <a class="block py-1 text-sm text-muted-foreground transition-colors hover:text-foreground" style={`padding-left:${(heading.depth - 2)}rem`} href={`#${heading.slug}`}>{heading.text}</a>
                                                ))}
                                            </nav>
                                        </div>
                                    </nav>
                                </aside>
                                <div class="max-w-2xl mx-auto min-w-0 contain-[inline-size]">
                                    <div class="prose dark:prose-invert prose-pre:bg-foreground prose-pre:text-background prose-pre:border prose-pre:border-border prose-pre:rounded prose-pre:px-5 prose-pre:py-4 dark:prose-pre:bg-muted dark:prose-pre:text-foreground dark:prose-pre:border-border prose-pre:overflow-x-auto max-w-none text-base sm:text-lg [&>div>p:first-child]:mt-0 [&>div>p:first-child]:pt-0 min-w-0 wrap-break-word [&_a]:break-all **:max-w-full">
                                        <Content />
                                    </div>
                                </div>
                            </div>
                            
                            <div class="max-w-2xl mx-auto border-t border-border pt-8 space-y-5">
                                <div class="flex flex-wrap items-center gap-2">
                                    {tags?.map((tag) => (
                                        <a class="inline-flex items-center gap-1.5 rounded-full border border-border px-3 py-1 text-sm text-muted-foreground transition hover:border-primary hover:text-primary" href={`${import.meta.env.BASE_URL}${lang}/tag/${tag.toLowerCase().replace(/\s+/g, '-')}`}># <!-- -->{tag}</a>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </article>
                </div>
            </div>
        </div>
    </section>

    <!-- Author card â€” between post content and footer -->
    <section class="pb-8">
        <div class="px-4 sm:px-8">
            <div class="w-full max-w-full xl:mx-auto xl:max-w-[80rem] 2xl:max-w-[90rem]">
                <div class="max-w-4xl w-full mx-auto">
                    <AuthorCard postCount={postCount} lang={lang} />
                </div>
            </div>
        </div>
    </section>
</Layout>
