---
import { Icon } from "astro-icon/components";
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import AuthorCard from "../../components/AuthorCard.astro";
import PostCard from "../../components/PostCard.astro";
import { useTranslations, usePlural } from "../../i18n/utils";
import { languages } from "../../i18n/ui";

export function getStaticPaths() {
    return Object.keys(languages).map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params;
const langStr = lang!; // getStaticPaths guarantees this is always defined
const t = useTranslations(lang as any);
const p = usePlural(lang as any);

const allPosts = await getCollection("blog", ({ slug }) =>
    slug.startsWith(`${lang}/`)
);
allPosts.sort(
    (a: CollectionEntry<"blog">, b: CollectionEntry<"blog">) =>
        b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

const heroPost = allPosts.length > 0 ? allPosts[0] : null;
const leftSidePosts = allPosts.slice(1, 3);
const rightSidePosts = allPosts.slice(3, 5);
const remainingPosts = allPosts.slice(5);

const remainingChunks = [];
for (let i = 0; i < remainingPosts.length; i += 3) {
    remainingChunks.push(remainingPosts.slice(i, i + 3));
}
---

<Layout
    title={t('home.seoTitle' as any)}
    description={t('home.about')}
    ogImage={`${import.meta.env.BASE_URL}og-default.png`}
>
    <h1 class="sr-only">{t('home.seoTitle' as any)}</h1>
    <div class="">
        <div
            class="w-full mx-auto xl:max-w-[80rem] 2xl:max-w-[90rem] px-4 sm:px-12 md:px-18 lg:px-16 xl:px-10"
        >
            <div class="flex flex-col gap-8 pt-2 sm:pt-10">
                <section class="pb-16">
                    <div class="space-y-6 w-full mx-auto">
                        <section
                            aria-labelledby="_R_4ltlb_"
                            class="flex flex-col gap-8"
                        >
                            <h2 id="_R_4ltlb_" class="sr-only">
                                Latest articles
                            </h2>
                            <div class="flex flex-col gap-8">
                                {
                                    allPosts.length > 0 && (
                                        <div class="rounded-xl border border-border bg-card overflow-hidden">
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4">
                                                {heroPost && (
                                                    <div class="order-1 lg:order-2 md:col-span-2 lg:col-span-2 border-b md:border-b-0 border-border">
                                                        <PostCard post={heroPost} lang={langStr} variant="hero" />
                                                    </div>
                                                )}

                                                <div class="order-2 lg:order-1 md:col-span-1 flex flex-col divide-y divide-border md:border-t lg:border-t-0 lg:border-r border-border">
                                                    {leftSidePosts.map((post: CollectionEntry<"blog">) => (
                                                        <div class="min-h-[140px] md:min-h-40 lg:min-h-[180px] flex-1">
                                                            <PostCard post={post} lang={langStr} variant="sidebar" />
                                                        </div>
                                                    ))}
                                                </div>

                                                <div class="order-3 md:col-span-1 flex flex-col divide-y divide-border border-t lg:border-t-0 lg:border-l border-border">
                                                    {rightSidePosts.map((post: CollectionEntry<"blog">) => (
                                                        <div class="min-h-[140px] md:min-h-40 lg:min-h-[180px] flex-1">
                                                            <PostCard post={post} lang={langStr} variant="sidebar" />
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )
                                }

                                <div
                                    class="grid grid-cols-1 gap-6 items-stretch lg:grid-cols-2"
                                >
                                    <aside
                                        aria-label="About the publication"
                                        class="h-full *:h-full"
                                    >
                                        <AuthorCard postCount={allPosts.length} lang={lang} />
                                    </aside>
                                    <section
                                        aria-label="Newsletter sign-up"
                                        class="h-full *:h-full"
                                    >
                                        <div
                                            class="rounded-xl border bg-card text-card-foreground transition hover:border-slate-400 dark:hover:border-slate-600 w-full flex flex-col justify-center p-5"
                                        >
                                            <div class="space-y-5">
                                                <div
                                                    class="flex items-start gap-3"
                                                >
                                                    <div
                                                        class="flex shrink-0 items-center justify-center rounded-full bg-muted border border-border h-12 w-12"
                                                    >
                                                        <Icon
                                                            name="fa6-solid:envelope"
                                                            class="fa-jelly text-lg"
                                                            aria-hidden="true"
                                                        />
                                                    </div>
                                                    <div
                                                        class="space-y-1 min-w-0"
                                                    >
                                                        <p
                                                            class="font-semibold text-foreground text-lg"
                                                        >
                                                            {t("home.subscribe")}
                                                        </p>
                                                        <p
                                                            class="text-sm text-muted-foreground"
                                                        >
                                                            {t("home.subscribeSubtitle")}
                                                        </p>
                                                    </div>
                                                </div>
                                                <form class="space-y-3">
                                                    <div
                                                        data-slot="input-group"
                                                        role="group"
                                                        class="group/input-group dark:bg-input/30 relative flex w-full items-center border shadow-xs transition-[color,box-shadow] outline-none min-w-0 has-[>textarea]:h-auto has-[>[data-align=inline-start]]:[&>input]:pl-2 has-[>[data-align=inline-end]]:[&>input]:pr-2 has-[>[data-align=block-start]]:h-auto has-[>[data-align=block-start]]:flex-col has-[>[data-align=block-start]]:[&>input]:pb-3 has-[>[data-align=block-end]]:h-auto has-[>[data-align=block-end]]:flex-col has-[>[data-align=block-end]]:[&>input]:pt-3 has-[[data-slot=input-group-control]:focus-visible]:border-ring has-[[data-slot=input-group-control]:focus-visible]:ring-ring/50 has-[[data-slot=input-group-control]:focus-visible]:ring-[3px] has-[[data-slot][aria-invalid=true]]:ring-destructive/20 has-[[data-slot][aria-invalid=true]]:border-destructive dark:has-[[data-slot][aria-invalid=true]]:ring-destructive/40 h-auto rounded-lg bg-muted border-border p-1.5 gap-2"
                                                    >
                                                        <input
                                                            type="email"
                                                            data-slot="input-group-control"
                                                            class="file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground border-input h-9 w-full min-w-0 px-3 transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive flex-1 rounded-none border-0 bg-transparent shadow-none focus-visible:ring-0 dark:bg-transparent py-3 text-base"
                                                            placeholder="you@example.com"
                                                            aria-label="Email address"
                                                            required=""
                                                            name="email"
                                                            value=""
                                                        />
                                                        <button
                                                            class="justify-center whitespace-nowrap font-medium transition-colors focus-visible:outline-hidden focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 bg-primary text-primary-foreground hover:bg-primary/90 text-sm shadow-none flex items-center h-8 gap-1.5 has-[>svg]:px-2.5 rounded-md px-4 py-0.5"
                                                            type="submit"
                                                            data-size="sm"
                                                            >Subscribe</button
                                                        >
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </section>
                                </div>

                                {
                                    remainingChunks.length > 0 && (
                                        <div class="flex flex-col gap-6">
                                            {remainingChunks.map((chunk) => (
                                                <div class="rounded-xl border border-border bg-card overflow-hidden">
                                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                                                        {chunk.map((post: CollectionEntry<"blog">, postIndex: number) => (
                                                            <div
                                                                class={
                                                                    postIndex === 0
                                                                        ? "border-border"
                                                                        : postIndex === 1
                                                                        ? "border-t md:border-t-0 md:border-l lg:border-l divide-border border-border"
                                                                        : "border-t md:col-span-2 md:border-t lg:col-span-1 lg:border-t-0 lg:border-l border-border"
                                                                }
                                                            >
                                                                <PostCard post={post} lang={langStr} variant="tile" />
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )
                                }

                                {
                                    remainingPosts.length > 0 && (
                                        <div class="flex justify-center py-8">
                                            <button
                                                type="button"
                                                class="group flex items-center gap-2 rounded-lg px-5 py-2.5 text-sm font-medium text-muted-foreground transition hover:bg-muted hover:text-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary disabled:opacity-50"
                                                aria-controls="_R_4ltlbH1_"
                                                aria-label="Load more posts"
                                            >
                                                <span aria-live="polite">
                                                    Load more posts
                                                </span>
                                                <Icon
                                                    name="fa6-solid:arrow-down"
                                                    class="text-sm transition-transform group-hover:translate-y-0.5"
                                                    aria-hidden="true"
                                                />
                                            </button>
                                        </div>
                                    )
                                }
                            </div>
                        </section>
                    </div>
                </section>
            </div>
        </div>
    </div>
</Layout>
